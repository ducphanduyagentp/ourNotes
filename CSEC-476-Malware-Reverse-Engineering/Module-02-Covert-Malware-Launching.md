# Covert Malware Launching

## Launchers

- .rsrc section, download from URL
- Common function calls to load resources
    - FindResource
    - LoadResource
    - SizeofResource

## Process Injection

- API calls
    - VirtualAllocEx
    - WriteProcessMemory
- Chapter 11: Code and memory vs Chapter 12: Running instances, threads, processes.

### DLL Injection

- API calls
    - Obtain handler to victim process: CreateToolhelp32Snapshot, Process32First, Process32Next
    - Create and execute a new thread in the remote process: CreateRemoteThread
- The victim process needs to call LoadLibrary and has the name of the DLL in the same space (using VirtualAllocEx above)
- Only injecting the name so LoadLibrary can call it. (Different from hooking in Ch.11)

### Direct Injection

- Code of the DLL instead of the name is injected.

## Process Replacement

- Replace the whole running process with a malicious process
- Create suspended so it won't run without privileges
- SetThreadContext so it uses privileges
- CONTEXT struct:
    - https://docs.microsoft.com/en-us/windows/desktop/api/winnt/ns-winnt-wow64_context
    - https://docs.microsoft.com/en-us/windows/desktop/api/winnt/ns-winnt-context
- https://github.com/fdiskyou/injectAllTheThings/blob/master/injectAllTheThings/t_suspendInjectResume.cpp

## Hook Injection

- What is it? Basically messages that can trigger some code.
- Taking advantages of Windows hooks, used to intercept messages destined for applications.
- Trigger certain events so messages got send and malicious code got run.

### Local and Remote

- Remote:
    - High level calls DLLs while low level don't.

### Keyloggers

- WH_KEYBOARD or WH_KEYBOARD_LL

### Targeting threads

- Trade-off between crashing or getting caught because hooking all threads can trigger an IPS or degrad the system

### SetWindowsHookExA

- Used to install a hook associated to a specific messages to be processed when an event is triggered.

## Detours

- There's a .detour section in a PE file that can specify a new address of the IAT and modify the IAT

## APC injection

- 